!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).SnapLineJs={})}(this,(function(t){"use strict";var s,i,h,e,n,r,l,o,a,u,c,d,f,p,g,m,b,w,_,v,D,E,M,y,W,C,x,R,k,A,O,I,L,P,j,S,T,X,Y,$,F,q,G,z,U,B,N,Q,H,K,Z,J,V,tt,st,it,ht,et=Object.defineProperty,nt=t=>{throw TypeError(t)},rt=(t,s,i)=>((t,s,i)=>s in t?et(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i),lt=(t,s,i)=>s.has(t)||nt("Cannot "+i),ot=(t,s,i)=>(lt(t,s,"read from private field"),i?i.call(t):s.get(t)),at=(t,s,i)=>s.has(t)?nt("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(t):s.set(t,i),ut=(t,s,i,h)=>(lt(t,s,"write to private field"),h?h.call(t,i):s.set(t,i),i),ct=(t,s,i)=>(lt(t,s,"access private method"),i);class dt{constructor(t,p={}){at(this,s),at(this,i),at(this,h),at(this,e),at(this,n),at(this,r),at(this,l),at(this,o),at(this,a),at(this,u),at(this,c),at(this,d),at(this,f);let g=t.getBoundingClientRect();ut(this,s,t),ut(this,i,g.left),ut(this,h,g.top),ut(this,e,g.width),ut(this,n,g.height),ut(this,r,0),ut(this,l,0),ut(this,o,0),ut(this,a,0),ut(this,u,1);ut(this,c,{enableZoom:!0,zoomBounds:{min:.2,max:1},enablePan:!0,panBounds:{top:null,left:null,right:null,bottom:null},...p}),ut(this,d,""),this.updateCamera(),ot(this,c).handleResize,ut(this,f,new ResizeObserver((()=>{this.updateCameraProperty()}))),ot(this,f).observe(ot(this,s)),ot(this,f).observe(window.document.body),window.addEventListener("scroll",(()=>{const t=ot(this,s).getBoundingClientRect();ut(this,i,t.left),ut(this,h,t.top),this.updateCamera()}))}get cameraWidth(){return ot(this,e)}get cameraHeight(){return ot(this,n)}get cameraPositionX(){return ot(this,r)}get cameraPositionY(){return ot(this,l)}get zoom(){return ot(this,u)}get containerOffsetX(){return ot(this,i)}get containerOffsetY(){return ot(this,h)}updateCameraProperty(){let t=ot(this,s).getBoundingClientRect();ut(this,i,t.left),ut(this,h,t.top),ut(this,e,t.width),ut(this,n,t.height)}worldToCameraMatrix(t,s,i){return`${i},0,0,0,0,${i},0,0,0,0,1,0,${-t*i},${-s*i},0,1`}updateCamera(){const t=this.worldToCameraMatrix(ot(this,r),ot(this,l),ot(this,u));ut(this,d,`matrix3d(${t})`)}get canvasStyle(){return ot(this,d)}setCameraPosition(t,s){ut(this,r,t),ut(this,l,s),this.updateCamera()}setCameraCenterPosition(t,s){ut(this,r,t-ot(this,e)/2),ut(this,l,s-ot(this,n)/2),this.updateCamera()}getCameraCenterPosition(){return{x:ot(this,r)+ot(this,e)/2,y:ot(this,l)+ot(this,n)/2}}handleScroll(t,s,i){if(!ot(this,c).enableZoom)return;ot(this,u)+t<.2?t=.2-ot(this,u):ot(this,u)+t>1&&(t=1-ot(this,u)),ot(this,c).zoomBounds&&(ot(this,u)+t<ot(this,c).zoomBounds.min||ot(this,u)+t>ot(this,c).zoomBounds.max)&&(t=0);const h=ot(this,u)/(ot(this,u)+t);ot(this,c).enablePan&&(ut(this,r,ot(this,r)-ot(this,e)/ot(this,u)*(h-1)*(1-(ot(this,e)-s)/ot(this,e))),ut(this,l,ot(this,l)-ot(this,n)/ot(this,u)*(h-1)*(1-(ot(this,n)-i)/ot(this,n)))),ut(this,u,ot(this,u)+t),this.updateCamera()}handlePan(t,s){ot(this,c).enablePan&&(ut(this,r,ot(this,r)+t/ot(this,u)),ut(this,l,ot(this,l)+s/ot(this,u)),this.updateCamera())}handlePanStart(){ot(this,c).enablePan&&(ut(this,o,ot(this,r)),ut(this,a,ot(this,l)))}handlePanDrag(t,s){ot(this,c).enablePan&&(ut(this,r,-t/ot(this,u)+ot(this,o)),ut(this,l,-s/ot(this,u)+ot(this,a)),ot(this,c).panBounds&&(null!==ot(this,c).panBounds.left&&ot(this,r)<ot(this,c).panBounds.left&&ut(this,r,ot(this,c).panBounds.left+1),null!==ot(this,c).panBounds.right&&ot(this,r)>ot(this,c).panBounds.right&&ut(this,r,ot(this,c).panBounds.right-1),null!==ot(this,c).panBounds.top&&ot(this,l)<ot(this,c).panBounds.top&&ut(this,l,ot(this,c).panBounds.top-1),null!==ot(this,c).panBounds.bottom&&ot(this,l)>ot(this,c).panBounds.bottom&&ut(this,l,ot(this,c).panBounds.bottom+1)),this.updateCamera())}handlePanEnd(){ot(this,c).enablePan&&(ut(this,o,0),ut(this,a,0))}getCameraFromWorld(t,s){return[(t-ot(this,r))*ot(this,u),(s-ot(this,l))*ot(this,u)]}getScreenFromCamera(t,s){return[t+ot(this,i),s+ot(this,h)]}getWorldFromCamera(t,s){return[t/ot(this,u)+ot(this,r),s/ot(this,u)+ot(this,l)]}getCameraFromScreen(t,s){return[t-=ot(this,i),s-=ot(this,h)]}getCameraDeltaFromWorldDelta(t,s){return[t*ot(this,u),s*ot(this,u)]}getWorldDeltaFromCameraDelta(t,s){return[t/ot(this,u),s/ot(this,u)]}}function ft(t,s){const i=s.getBoundingClientRect();if(null==t||null==t.camera)return{height:i.height,width:i.width,x:i.left,y:i.top,cameraX:i.left,cameraY:i.top,screenX:i.left,screenY:i.top};const[h,e]=t.camera.getCameraFromScreen(i.left,i.top),[n,r]=t.camera.getWorldFromCamera(h,e),[l,o]=t.camera.getCameraDeltaFromWorldDelta(i.width,i.height),[a,u]=t.camera.getWorldDeltaFromCameraDelta(l,o);return{height:u,width:a,x:n,y:r,cameraX:h,cameraY:e,screenX:i.left,screenY:i.top}}function pt(t){return`translate3d(${t.x}px, ${t.y}px, 0px) scale(${t.scaleX}, ${t.scaleY}) `}function gt(t,s){Object.assign(t.style,s)}function mt(t,s,i=null){return new Proxy(s,{set:(s,i,h)=>(s[i]=null==h?null:h.bind(t),!0),get:(t,s)=>(...h)=>{var e,n;null==(e=t[s])||e.call(t,...h),null==(n=null==i?void 0:i[s])||n.call(i,...h)}})}s=new WeakMap,i=new WeakMap,h=new WeakMap,e=new WeakMap,n=new WeakMap,r=new WeakMap,l=new WeakMap,o=new WeakMap,a=new WeakMap,u=new WeakMap,c=new WeakMap,d=new WeakMap,f=new WeakMap;let bt=class{constructor(t){rt(this,"_object"),rt(this,"_global"),rt(this,"global"),rt(this,"_input"),rt(this,"input"),rt(this,"_dom"),rt(this,"dom"),this.t=t,this.i={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,drag:null,pinch:null,dragStart:null,dragEnd:null,pinchStart:null,pinchEnd:null},this.global=new Proxy(this.i,{set:(t,s,i)=>{const h=this.t.global.getInputEngine(this.t.engine);return null==i?null==h||h.unsubscribeGlobalCursorEvent(s,this.t.gid):null==h||h.subscribeGlobalCursorEvent(s,this.t.gid,i.bind(this.t),this.t.engine),!0}}),this.h={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.input=mt(this.t,this.h),this.l={onAssignDom:null,onResize:null},this.dom=mt(this.t,this.l)}};class wt{constructor(t,s,i=null){rt(this,"uuid"),rt(this,"object"),rt(this,"callback"),this.uuid=i??t.global.getGlobalId(),this.object=t,this.callback=s?[s.bind(t)]:null}addCallback(t){this.callback?this.callback.push(t.bind(this.object)):this.callback=[t.bind(this.object)]}}const _t=new WeakMap;class vt{constructor(t,s){rt(this,"global"),rt(this,"engine"),rt(this,"gid"),rt(this,"parent"),rt(this,"children",[]),rt(this,"transform"),rt(this,"local"),rt(this,"offset"),rt(this,"event"),rt(this,"_requestPreRead",!1),rt(this,"_requestWrite",!1),rt(this,"_requestRead",!1),rt(this,"_requestDelete",!1),rt(this,"_requestPostWrite",!1),rt(this,"_colliderList",[]),rt(this,"_animationList",[]),rt(this,"_globalInput"),rt(this,"globalInput"),t.global?(this.engine=t,this.global=t.global):(this.global=t,this.engine=null),this.gid=this.global.getGlobalId(),this.global.registerObject(this),this.parent=s,this.o=[],this.transform={x:0,y:0,scaleX:1,scaleY:1},this.local={x:0,y:0,scaleX:1,scaleY:1},this.offset={x:0,y:0,scaleX:1,scaleY:1},this.event=new bt(this),this.u=!1,this.p=!1,this.m=!1,this._=!1,this.v=!1,this.D={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.globalInput=new Proxy(this.D,{set:(t,s,i)=>{const h=this.global.getInputEngine(this.engine);return null==i?null==h||h.unsubscribeGlobalCursorEvent(s,this.gid):null==h||h.subscribeGlobalCursorEvent(s,this.gid,i.bind(this),this.engine),!0}})}destroy(){this.cancelAnimations(),this.global.unregisterObject(this)}get worldPosition(){return[this.transform.x,this.transform.y]}set worldPosition(t){this.transform.x=t[0],this.transform.y=t[1]}get cameraPosition(){var t;return(null==(t=this.engine.camera)?void 0:t.getCameraFromWorld(...this.worldPosition))??[0,0]}set cameraPosition(t){var s,i;this.worldPosition=(null==(i=null==(s=this.engine)?void 0:s.camera)?void 0:i.getWorldFromCamera(...t))??[0,0]}get screenPosition(){var t;return(null==(t=this.engine.camera)?void 0:t.getScreenFromCamera(...this.cameraPosition))??[0,0]}set screenPosition(t){var s,i;this.cameraPosition=(null==(i=null==(s=this.engine)?void 0:s.camera)?void 0:i.getCameraFromScreen(...t))??[0,0]}queueUpdate(t="READ_1",s=null,i=null){const h=new wt(this,s,i);let e=this.global.read1Queue;switch(t){case"READ_1":e=this.global.read1Queue;break;case"WRITE_1":e=this.global.write1Queue;break;case"READ_2":e=this.global.read2Queue;break;case"WRITE_2":e=this.global.write2Queue;break;case"READ_3":e=this.global.read3Queue;break;case"WRITE_3":e=this.global.write3Queue}return e.get(this.gid)||e.set(this.gid,new Map),e.get(this.gid).set(h.uuid,h),h}readDom(t=!1){for(const s of this.o)s.read()}writeDom(){}writeTransform(){}destroyDom(){}calculateLocalFromTransform(){this.parent&&(this.transform.x=this.parent.transform.x+this.local.x,this.transform.y=this.parent.transform.y+this.local.y);for(const t of this.o)t.recalculate()}addAnimation(t,s={}){var i,h;null==(i=this.engine)||i.enableAnimationEngine();return(s.replaceExisting??!0)&&this.cancelAnimations(),this.M.push(t),_t.set(t,this),null==(h=this.engine)||h.animationList.push(t),t}cancelAnimations(){for(const t of[...this.M])t.requestDelete=!0,t.cancel(),this.removeAnimationReference(t)}removeAnimationReference(t){this.M=this.M.filter((s=>s!==t)),_t.delete(t)}async animate(t,s){const{AnimationObject:i}=await Promise.resolve().then((()=>qt)),h=new i(this.element,t,s);return this.addAnimation(h,{replaceExisting:!0})}async animateSequence(t){const{SequenceObject:s}=await Promise.resolve().then((()=>qt)),i=new s;for(const h of t)i.add(h);return this.addAnimation(i,{replaceExisting:!0})}get animation(){return 0===this.M.length?null:this.M[this.M.length-1]}getCurrentStats(){return{timestamp:Date.now()}}addCollider(t){var s;this.o.push(t),this.engine&&(null==(s=this.engine.collisionEngine)||s.addObject(t))}addDebugPoint(t,s,i="red",h=!1,e=""){this.engine&&(this.engine.debugMarkerList[`${this.gid}-${e}`]={gid:this.gid,type:"point",color:i,x:t,y:s,persistent:h,id:`${this.gid}-${e}`})}addDebugRect(t,s,i,h,e="red",n=!1,r="",l=!0,o=1){this.engine&&(this.engine.debugMarkerList[`${this.gid}-${r}`]={gid:this.gid,type:"rect",color:e,x:t,y:s,width:i,height:h,persistent:n,id:`${this.gid}-${r}`,filled:l,lineWidth:o})}addDebugLine(t,s,i,h,e="red",n=!1,r="",l=2){this.engine&&(this.engine.debugMarkerList[`${this.gid}-${r}`]={gid:this.gid,type:"line",color:e,x:t,y:s,x2:i,y2:h,persistent:n,id:`${this.gid}-${r}`,lineWidth:l})}addDebugCircle(t,s,i,h="red",e=!1,n=""){this.engine&&(this.engine.debugMarkerList[`${this.gid}-${n}`]={gid:this.gid,type:"circle",color:h,x:t,y:s,radius:i,persistent:e,id:`${this.gid}-${n}`})}addDebugText(t,s,i,h="red",e=!1,n=""){this.engine&&(this.engine.debugMarkerList[`${this.gid}-${n}`]={gid:this.gid,x:t,y:s,type:"text",color:h,text:i,persistent:e,id:`${this.gid}-${n}`})}clearDebugMarker(t){this.engine&&delete this.engine.debugMarkerList[`${this.gid}-${t}`]}clearAllDebugMarkers(){if(this.engine)for(const t of Object.values(this.engine.debugMarkerList))t.gid==this.gid&&delete this.engine.debugMarkerList[t.id]}}function Dt(t){const s=_t.get(t);s&&s.removeAnimationReference(t)}class Et{constructor(t,s,i=null,h={},e=!1){rt(this,"_uuid"),rt(this,"_global"),rt(this,"_engine"),rt(this,"_owner"),rt(this,"element"),rt(this,"_pendingInsert"),rt(this,"_requestWrite",!1),rt(this,"_requestRead",!1),rt(this,"_requestDelete",!1),rt(this,"_requestPostWrite",!1),rt(this,"_style"),rt(this,"_classList"),rt(this,"_dataAttribute"),rt(this,"property"),rt(this,"_transformApplied"),rt(this,"insertMode"),rt(this,"resizeObserver",null),rt(this,"mutationObserver",null),t.global?(this.W=t,this.i=t.global):(this.i=t,this.W=null),this.element=i,this.property={x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},this.C={x:0,y:0,scaleX:1,scaleY:1},this.R=e,this.k=s,this.A=(++this.i.gid).toString(),this.p=!1,this.m=!1,this._=!1,this.v=!1,this.O={},this.I={},this.L=[],this.insertMode=h}addElement(t){this.element=t,this.k.requestWrite(),this.k.requestRead(),this.resizeObserver=new ResizeObserver((()=>{var t,s;null==(s=(t=this.k.event.dom).onResize)||s.call(t)})),this.resizeObserver.observe(t),this.mutationObserver=new MutationObserver((()=>{var t,s;null==(s=(t=this.k.event.dom).onResize)||s.call(t)}))}set style(t){this.O=Object.assign(this.O,t)}get style(){return this.O}set dataAttribute(t){this.I=Object.assign(this.I,t)}get dataAttribute(){return this.I}set classList(t){this.L=t}get classList(){return this.L}readDom(t=!1){if(!this.element)throw new Error("Element is not set");const s=ft(this.W,this.element),i=this.element.style.transform;let h={x:0,y:0,scaleX:1,scaleY:1};i&&"none"!=i&&t&&(h=function(t){const s=t.split("(")[1].split(")")[0].split(",");return{x:parseFloat(s[0]),y:parseFloat(s[1]),scaleX:parseFloat(s[3])||1,scaleY:parseFloat(s[4])||1}}(i)),this.property.height=s.height/h.scaleY,this.property.width=s.width/h.scaleX,this.property.x=s.x-h.x,this.property.y=s.y-h.y,this.property.screenX=s.screenX,this.property.screenY=s.screenY}writeDom(){if(this.element){gt(this.element,this.O),this.element.classList.forEach((t=>{this.element.classList.add(t)}));for(const[t,s]of Object.entries(this.I))this.element.setAttribute(`data-${t}`,s);this.element.setAttribute("data-engine-gid",this.k.gid)}}writeTransform(){if(!this.element)return;let t={transform:""};if("direct"==this.k.transformMode)t={transform:pt({x:this.k.transform.x+this.k.offset.x,y:this.k.transform.y+this.k.offset.y,scaleX:this.k.transform.scaleX,scaleY:this.k.transform.scaleY})};else if("relative"==this.k.transformMode){const[s,i]=[this.k.transform.x-this.property.x,this.k.transform.y-this.property.y];t={transform:pt({x:s+this.k.offset.x,y:i+this.k.offset.y,scaleX:this.k.transform.scaleX,scaleY:this.k.transform.scaleY})}}else if("none"==this.k.transformMode)t={transform:""};else if("offset"==this.k.transformMode){if(!this.k.transformOrigin)throw new Error("Transform origin is not set");t={transform:pt({x:this.k.transform.x-this.k.transformOrigin.transform.x,y:this.k.transform.y-this.k.transformOrigin.transform.y,scaleX:this.k.transform.scaleX*this.k.transformOrigin.transform.scaleX,scaleY:this.k.transform.scaleY*this.k.transformOrigin.transform.scaleY})}}null!=this.O.transform&&""!=this.O.transform&&""!=t.transform&&(t.transform=this.O.transform),gt(this.element,{...this.O,...t})}destroyDom(){var t,s;null==(t=this.resizeObserver)||t.disconnect(),null==(s=this.mutationObserver)||s.disconnect(),this.element&&this.element.remove(),this.element=null}}class Mt extends vt{constructor(t,s){super(t,s),rt(this,"_dom"),rt(this,"_requestWrite"),rt(this,"_requestRead"),rt(this,"_requestDelete"),rt(this,"_requestPostWrite"),rt(this,"_state",{}),rt(this,"state"),rt(this,"transformMode"),rt(this,"transformOrigin"),rt(this,"_domProperty"),rt(this,"inScene",!1),rt(this,"_callback"),rt(this,"callback"),rt(this,"inputEngine"),this.l=new Et(t,this,null),this.inScene=!1,this.p=!1,this.m=!1,this._=!1,this.v=!1,this.P=[{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0},{x:0,y:0,height:0,width:0,scaleX:1,scaleY:1,screenX:0,screenY:0}],this.transformMode="direct",this.transformOrigin=null,this.j={afterRead1:null,afterRead2:null,afterRead3:null,afterWrite1:null,afterWrite2:null,afterWrite3:null},this.callback=mt(this,this.j),this.state=new Proxy(this.S,{set:(t,s,i)=>(t[s]=i,!0)}),this.inputEngine=new Wt(this.engine,!1,this.gid)}destroy(){this.l.destroyDom(),super.destroy()}getDomProperty(t=null){const s="READ_1"==t?0:"READ_2"==t?1:2;return this.P[s]}copyDomProperty(t,s){const i="READ_1"==t?0:"READ_2"==t?1:2,h="READ_1"==s?0:"READ_2"==s?1:2;Object.assign(this.P[h],this.P[i])}saveDomPropertyToTransform(t=null){let s=t??this.global.currentStage;s="IDLE"==s?"READ_2":s;const i=this.getDomProperty(s);this.worldPosition=[i.x,i.y]}calculateLocalFromTransform(){this.parent&&(this.local.x=this.transform.x-this.parent.transform.x,this.local.y=this.transform.y-this.parent.transform.y)}calculateLocalFromDom(t=null){if(this.parent){const s=this.getDomProperty(t);this.parent instanceof Mt?(this.local.x=s.x-this.parent.getDomProperty(t).x,this.local.y=s.y-this.parent.getDomProperty(t).y):(this.local.x=this.transform.x-this.parent.transform.x,this.local.y=this.transform.y-this.parent.transform.y)}}calculateTransformFromLocal(){this.parent&&(this.transform.x=this.parent.transform.x+this.local.x,this.transform.y=this.parent.transform.y+this.local.y)}get style(){return this.l.style}set style(t){this.l.style=t}get classList(){return this.l.classList}set classList(t){this.l.classList=t}get dataAttribute(){return this.l.dataAttribute}set dataAttribute(t){this.l.dataAttribute=t}get element(){return this.l.element}set element(t){var s,i,h,e;if(!t)return;this.l.addElement(t),null==(s=this.inputEngine)||s.addCursorEventListener(t);const n=Object.keys(this.inputEngine.event);for(const r of n){const t=(null==(i=this.event.input[r])?void 0:i.bind(this))||null;this.inputEngine.event[r]=t}null==(e=(h=this.event.dom).onAssignDom)||e.call(h)}readDom(t=!1,s=null){let i=s??this.global.currentStage;i="IDLE"==i?"READ_2":i,this.l.readDom(t),super.readDom(t),"READ_1"==i?Object.assign(this.P[0],this.l.property):"READ_2"==i?Object.assign(this.P[1],this.l.property):"READ_3"==i&&Object.assign(this.P[2],this.l.property)}writeDom(){this.l.writeDom(),super.writeDom()}writeTransform(){this.l.writeTransform(),super.writeTransform()}destroyDom(){this.l.destroyDom(),super.destroyDom()}requestRead(t=!1,s=!0,i="READ_1"){return this.queueUpdate(i,(()=>{this.readDom(t),s&&this.saveDomPropertyToTransform(i)}),i)}requestWrite(t=!0,s=null,i="WRITE_1"){return this.queueUpdate(i,(()=>{t&&this.writeDom(),null==s||s()}),i)}requestDestroy(){return this.queueUpdate("WRITE_2",(()=>{this.destroyDom()}),"destroy")}requestTransform(t="WRITE_2"){return this.queueUpdate(t,(()=>{this.writeTransform()}),"transform")}requestFLIP(t,s){this.requestRead(!1,!0,"READ_1"),this.requestWrite(!0,t,"WRITE_1"),this.requestRead(!1,!0,"READ_2"),this.requestWrite(!1,s,"WRITE_2")}}const yt="global";class Wt{constructor(t,s=!0,i=null){var h;at(this,b),rt(this,"_element"),rt(this,"global"),rt(this,"_sortedTouchArray"),rt(this,"_sortedTouchDict"),rt(this,"_localPointerDict"),rt(this,"_event"),rt(this,"event"),rt(this,"_isGlobal"),rt(this,"_uuid"),rt(this,"_ownerGID"),at(this,p),at(this,g),at(this,m),rt(this,"engine"),this.engine=t,this.global=t.global,this.T=null,this.X=s,this.Y=[],this.$={},this.F=i,this.q={},ut(this,g,[]),ut(this,m,[]),this.G={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.event=mt(this,this.G,this.X?null:null==(h=this.globalInputEngine)?void 0:h.U.event),this.A=Symbol(),ut(this,p,new vt(this.global,null))}destroy(){for(const t of ot(this,m))t.abort();ut(this,m,[]),this.T=null,this.Y=[],this.$={},this.q={}}get globalInputEngine(){return this.global?this.global.getInputEngine(this.engine??null):null}get globalPointerDict(){return null==this.globalInputEngine?{}:this.globalInputEngine.B}get globalGestureDict(){return null==this.globalInputEngine?{}:this.globalInputEngine.N}getCoordinates(t,s){if(null==this.engine||null==this.engine.camera)return{x:t,y:s,cameraX:t,cameraY:s,screenX:t,screenY:s};const[i,h]=this.engine.camera.getCameraFromScreen(t,s),[e,n]=this.engine.camera.getWorldFromCamera(i,h);return{x:e,y:n,cameraX:i,cameraY:h,screenX:t,screenY:s}}onPointerDown(t){var s,i,h,e,n;if(!ct(this,b,_).call(this,t.target))return;t.stopPropagation();const r=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerDown)||i.call(s,{event:t,position:r,gid:this.X?yt:this.F,button:t.buttons});const l={id:t.pointerId,callerGID:this.X?yt:this.F,timestamp:t.timeStamp,x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,prevX:t.clientX,prevY:t.clientY,endX:null,endY:null,moveCount:0};this.globalPointerDict[t.pointerId]=l,null==(e=(h=this.event).dragStart)||e.call(h,{gid:this.X?yt:this.F,pointerId:t.pointerId,start:r,button:t.buttons}),ot(this,p).addDebugPoint(r.x,r.y,"red",!0,"pointerDown"),this.globalGestureDict[t.pointerId]?this.globalGestureDict[t.pointerId].memberList.push(this):(this.globalGestureDict[t.pointerId]={type:"drag",state:"drag",memberList:[this,...ot(this,g)],initiatorID:this.X?yt:this.F??""},null==(n=this.globalInputEngine)||n.enforceMaxDragLimit())}onPointerMove(t){var s,i;if(!ct(this,b,v).call(this,t,{allowHover:!0}))return;t.preventDefault();const h=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerMove)||i.call(s,{event:t,position:h,gid:this.X?yt:this.F,button:t.buttons});const e=t.pointerId;let n=this.globalPointerDict[e];if(null!=n){const s={prevX:n.x,prevY:n.y,x:t.clientX,y:t.clientY,callerGID:this.X?yt:this.F};Object.assign(n,s),ct(this,b,E).call(this,t)}t.stopPropagation()}onPointerUp(t){var s,i,h,e,n,r;if(!ct(this,b,v).call(this,t))return;t.preventDefault();const l=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).pointerUp)||i.call(s,{event:t,position:l,gid:this.X?yt:this.F,button:t.buttons});let o=this.globalPointerDict[t.pointerId];if(null!=o){const s=this.globalGestureDict[t.pointerId];if(null!=s){s.state="release";const i=this.getCoordinates(o.startX,o.startY);for(const n of s.memberList)null==(e=(h=n.event).dragEnd)||e.call(h,{gid:this.X?yt:this.F,pointerId:t.pointerId,start:i,end:l,button:t.buttons});delete this.globalGestureDict[t.pointerId]}delete this.globalPointerDict[t.pointerId];for(const i of Object.keys(this.globalGestureDict)){if(!i.includes("-"))continue;const[s,h]=i.split("-").map(Number);if(s==t.pointerId||h==t.pointerId){const t=this.globalGestureDict[i];null==(r=(n=this.event).pinchEnd)||r.call(n,{gid:this.X?yt:this.F,gestureID:i,start:t.start,pointerList:t.pointerList,distance:t.distance,end:{pointerList:t.pointerList,distance:t.distance}}),delete this.globalGestureDict[i]}}}t.stopPropagation()}onPointerCancel(t){this.onPointerUp(t)}onWheel(t){var s,i;if(!ct(this,b,D).call(this,t))return;const h=this.getCoordinates(t.clientX,t.clientY);null==(i=(s=this.event).mouseWheel)||i.call(s,{event:t,position:h,delta:t.deltaY,gid:this.X?yt:this.F}),t.stopPropagation()}H(){var t,s,i,h;const e=Object.values(this.globalPointerDict);if(!(e.length<2)){e.sort(((t,s)=>t.timestamp-s.timestamp));for(let n=0;n<e.length-1;n++){const r=e[n],l=e[n+1],o=`${r.id}-${l.id}`,a=(r.startX+l.startX)/2,u=(r.startY+l.startY)/2,c=(this.getCoordinates(a,u),Math.sqrt(Math.pow(r.startX-l.startX,2)+Math.pow(r.startY-l.startY,2))),d=this.getCoordinates(r.x,r.y),f=this.getCoordinates(l.x,l.y),p=Math.sqrt(Math.pow(r.x-l.x,2)+Math.pow(r.y-l.y,2));null==this.globalGestureDict[o]&&(this.globalGestureDict[o]={type:"pinch",state:"pinch",memberList:[this],start:{pointerList:[d,f],distance:c},pointerList:[d,f],distance:c},null==(s=(t=this.event).pinchStart)||s.call(t,{gid:this.X?yt:this.F,gestureID:o,start:{pointerList:[d,f],distance:c}}));const g=this.globalGestureDict[o];g.pointerList=[d,f],g.distance=p,null==(h=(i=this.event).pinch)||h.call(i,{gid:this.X?yt:this.F,gestureID:o,start:g.start,pointerList:g.pointerList,distance:g.distance})}}}addListener(t,s,i){const h=new AbortController,e=i.bind(this);t.addEventListener(s,e,{signal:h.signal}),ot(this,m).push(h)}addCursorEventListener(t){this.addListener(t,"pointerdown",this.onPointerDown),this.addListener(t,"pointermove",this.onPointerMove),this.addListener(t,"pointerup",this.onPointerUp),this.addListener(t,"pointercancel",this.onPointerCancel),this.addListener(t,"wheel",this.onWheel)}addDragMember(t){ot(this,g).push(t)}resetDragMembers(){ut(this,g,[])}}p=new WeakMap,g=new WeakMap,m=new WeakMap,b=new WeakSet,w=function(t){return null!=this.globalPointerDict[t]},_=function(t){var s;const i=null==(s=this.engine)?void 0:s.containerElement;return null==i||t instanceof Node&&i.contains(t)},v=function(t,s={}){const{allowHover:i=!1}=s;return!!ct(this,b,w).call(this,t.pointerId)||ct(this,b,_).call(this,t.target)},D=function(t){return ct(this,b,_).call(this,t.target)},E=function(t){var s,i;const h=Object.keys(this.globalPointerDict).length;if(h>=1)for(const e of Object.values(this.globalPointerDict)){if((this.X?yt:this.F)!=e.callerGID)continue;e.moveCount++;const h=this.globalGestureDict[e.id];if(h)for(const n of h.memberList){const h=n.getCoordinates(e.startX,e.startY),r=n.getCoordinates(e.x,e.y),l={x:r.x-h.x,y:r.y-h.y,cameraX:r.cameraX-h.cameraX,cameraY:r.cameraY-h.cameraY,screenX:r.screenX-h.screenX,screenY:r.screenY-h.screenY};null==(i=(s=n.event).drag)||i.call(s,{gid:n.X?yt:n.F,pointerId:e.id,start:h,position:r,delta:l,button:t.buttons})}}if(h>=2)if(this.X)this.H();else{const t=this.globalInputEngine;t&&t.U.H()}};const Ct={maxSimultaneousDrags:1/0};class xt{constructor(t,s={}){at(this,M),rt(this,"global"),rt(this,"_inputControl"),rt(this,"globalCallbacks"),rt(this,"_pointerDict"),rt(this,"_gestureDict"),rt(this,"_event"),rt(this,"event"),rt(this,"config"),this.global=t,ut(this,M,document),this.config={...Ct,...s},this.U=new Wt({global:t},!0,null),this.U.addCursorEventListener(ot(this,M)),this.globalCallbacks={pointerDown:{},pointerMove:{},pointerUp:{},mouseWheel:{},dragStart:{},drag:{},dragEnd:{},pinchStart:{},pinch:{},pinchEnd:{}},this.B={},this.N={};const i=(t,s)=>{if(!t||null==t.screenX||null==t.screenY||!s)return t;const[i,h]=s.getCameraFromScreen(t.screenX,t.screenY),[e,n]=s.getWorldFromCamera(i,h);return{x:e,y:n,cameraX:i,cameraY:h,screenX:t.screenX,screenY:t.screenY}},h=(t,s)=>t&&s?t.map((t=>i(t,s))):t;for(const[e]of Object.entries(this.globalCallbacks))this.U.event[e]=t=>{for(const{callback:s,engine:n}of Object.values(this.globalCallbacks[e])){const e=s=>{if(!(null==s?void 0:s.camera))return t;const e={...t};return t.position&&(e.position=i(t.position,s.camera)),t.start&&(t.start.pointerList?e.start={...t.start,pointerList:h(t.start.pointerList,s.camera)}:e.start=i(t.start,s.camera)),t.end&&(t.end.pointerList?e.end={...t.end,pointerList:h(t.end.pointerList,s.camera)}:e.end=i(t.end,s.camera)),t.delta&&(e.delta=i(t.delta,s.camera)),t.pointerList&&(e.pointerList=h(t.pointerList,s.camera)),e};if(n)s(e(n));else if(this.global&&this.global.engines&&this.global.engines.size>0)for(const t of this.global.engines)s(e(t));else s(t)}};this.G={pointerDown:null,pointerMove:null,pointerUp:null,mouseWheel:null,dragStart:null,drag:null,dragEnd:null,pinchStart:null,pinch:null,pinchEnd:null},this.event=new Proxy(this.G,{set:(t,s,i)=>(null!=i?this.subscribeGlobalCursorEvent(s,yt,i.bind(this),null):this.unsubscribeGlobalCursorEvent(s,yt),!0)})}destroy(){this.U.destroy(),this.globalCallbacks={pointerDown:{},pointerMove:{},pointerUp:{},mouseWheel:{},dragStart:{},drag:{},dragEnd:{},pinchStart:{},pinch:{},pinchEnd:{}},this.B={},this.N={}}subscribeGlobalCursorEvent(t,s,i,h){this.globalCallbacks[t][s]={callback:i,engine:h}}unsubscribeGlobalCursorEvent(t,s){delete this.globalCallbacks[t][s]}getActiveDragCount(){return Object.values(this.N).filter((t=>"drag"===t.type)).length}getActiveDragsSortedByTime(){const t=[];for(const[s,i]of Object.entries(this.N)){if("drag"!==i.type)continue;const h=parseInt(s,10),e=this.B[h];e&&t.push({pointerId:h,gesture:i,timestamp:e.timestamp})}return t.sort(((t,s)=>t.timestamp-s.timestamp))}cancelOldestDrag(){var t,s;const i=this.getActiveDragsSortedByTime();if(0===i.length)return;const h=i[0],e=this.B[h.pointerId];if(e){for(const i of h.gesture.memberList){const n=i.getCoordinates(e.startX,e.startY),r=i.getCoordinates(e.x,e.y);null==(s=(t=i.event).dragEnd)||s.call(t,{gid:i.X?yt:i.F,pointerId:h.pointerId,start:n,end:r,button:0})}delete this.N[h.pointerId],delete this.B[h.pointerId]}}enforceMaxDragLimit(){const t=this.config.maxSimultaneousDrags;if(!(t<=0||t===1/0))for(;this.getActiveDragCount()>t;)this.cancelOldestDrag()}}M=new WeakMap;const Rt=class t{constructor(){at(this,x),rt(this,"inputEngine"),rt(this,"objectTable"),rt(this,"data"),rt(this,"gid"),at(this,y),at(this,W),rt(this,"currentStage"),rt(this,"read1Queue"),rt(this,"write1Queue"),rt(this,"read2Queue"),rt(this,"write2Queue"),rt(this,"read3Queue"),rt(this,"write3Queue"),rt(this,"engines"),at(this,C,null),this.objectTable={},this.inputEngine=null,this.data={},this.gid=0,ut(this,y,0),ut(this,W,new WeakMap),this.currentStage="IDLE",this.read1Queue=new Map,this.write1Queue=new Map,this.read2Queue=new Map,this.write2Queue=new Map,this.read3Queue=new Map,this.write3Queue=new Map,this.engines=new Set}static getInstance(){return t.instance||(t.instance=new t),t.instance}static resetInstance(){t.instance=null}registerEngine(t){this.engines.add(t),ct(this,x,O).call(this,t),ct(this,x,A).call(this,t),1===this.engines.size&&ct(this,x,R).call(this)}unregisterEngine(t){var s;this.engines.delete(t);const i=ot(this,W).get(t);i&&(delete this.objectTable[i],ot(this,W).delete(t)),0===this.engines.size&&(null==(s=this.inputEngine)||s.destroy(),this.inputEngine=null,ct(this,x,k).call(this))}getGlobalId(){return this.gid++,this.gid.toString()}getInputEngine(t){return t||this.inputEngine?this.inputEngine??ct(this,x,A).call(this,t):null}getEngineId(t){return t?ot(this,W).get(t)??null:null}getEngineObjectTable(s,i=!0){if(!s)return i||this.objectTable[t.GLOBAL_ENGINE_KEY]?ct(this,x,I).call(this):null;let h=ot(this,W).get(s);if(!h){if(!i)return null;h=ct(this,x,O).call(this,s)}if(!this.objectTable[h]){if(!i)return null;this.objectTable[h]={}}return this.objectTable[h]}registerObject(t){const s=this.getEngineObjectTable(t.engine??null,!0);s&&(s[t.gid]=t)}unregisterObject(s){const i=this.getEngineObjectTable(s.engine??null,!1);if(i&&(delete i[s.gid],0===Object.keys(i).length)){const i=s.engine&&ot(this,W).get(s.engine)?ot(this,W).get(s.engine):t.GLOBAL_ENGINE_KEY;delete this.objectTable[i]}}};y=new WeakMap,W=new WeakMap,C=new WeakMap,x=new WeakSet,R=function(){if(null!==ot(this,C))return;const t=()=>{const s=Date.now();this.currentStage="READ_1";for(const t of this.engines)t.K("READ_1",this.read1Queue,s);this.read1Queue=new Map,this.currentStage="WRITE_1";for(const t of this.engines)t.K("WRITE_1",this.write1Queue,s);this.write1Queue=new Map,this.currentStage="READ_2";for(const t of this.engines)t.K("READ_2",this.read2Queue,s);this.read2Queue=new Map,this.currentStage="WRITE_2";for(const t of this.engines)t.K("WRITE_2",this.write2Queue,s);this.write2Queue=new Map;for(const t of this.engines)t.Z(s);this.currentStage="READ_3";for(const t of this.engines)t.K("READ_3",this.read3Queue,s);this.read3Queue=new Map,this.currentStage="WRITE_3";for(const t of this.engines)t.K("WRITE_3",this.write3Queue,s);this.write3Queue=new Map,this.currentStage="IDLE";for(const t of this.engines)t.J(s);ut(this,C,window.requestAnimationFrame(t))};ut(this,C,window.requestAnimationFrame(t))},k=function(){null!==ot(this,C)&&(window.cancelAnimationFrame(ot(this,C)),ut(this,C,null))},A=function(t){return this.inputEngine||(this.inputEngine=new xt(this)),this.inputEngine},O=function(t){let s=ot(this,W).get(t);var i,h,e,n;return s||((i=this,h=y,{set V(t){ut(i,h,t,e)},get V(){return ot(i,h,n)}}).V++,s=`engine-${ot(this,y)}`,ot(this,W).set(t,s)),this.objectTable[s]||(this.objectTable[s]={}),s},I=function(){const t=Rt.GLOBAL_ENGINE_KEY;return this.objectTable[t]||(this.objectTable[t]={}),this.objectTable[t]},rt(Rt,"instance",null),rt(Rt,"GLOBAL_ENGINE_KEY","__global__");let kt=Rt;class At{constructor(t){rt(this,"_object"),rt(this,"_collider"),rt(this,"collider"),this.t=t,this.tt={onCollide:null,onBeginContact:null,onEndContact:null},this.collider=mt(t,this.tt)}}class Ot{constructor(t,s,i,h,e){rt(this,"global"),rt(this,"engine"),rt(this,"parent"),rt(this,"type"),rt(this,"uuid"),rt(this,"_element"),rt(this,"inputEngine"),rt(this,"transform"),rt(this,"event"),rt(this,"_currentCollisions"),rt(this,"_iterationCollisions"),this.engine=t,this.global=t.global,this.parent=s,this.type=i,this.uuid=Symbol(),this.T=null,this.transform={x:h,y:e,width:0,height:0},this.event=new At(this.parent),this.st=new Set,this.it=new Set,this.recalculate(),this.inputEngine=new Wt(this.engine)}get worldPosition(){return[this.parent.transform.x+this.transform.x,this.parent.transform.y+this.transform.y]}set worldPosition([t,s]){this.transform.x=t-this.parent.transform.x,this.transform.y=s-this.parent.transform.y}set element(t){this.T=t,this.parent.hasOwnProperty("element")?this.parent.requestRead():this.recalculate()}read(){if(!this.element)return;const t=ft(this.parent.engine,this.element);this.transform.x=t.x-this.parent.transform.x,this.transform.y=t.y-this.parent.transform.y,this.transform.width=t.width,this.transform.height=t.height}recalculate(){}}class It extends Ot{constructor(t,s,i,h,e,n){super(t,s,"rect",i,h),this.transform.width=e,this.transform.height=n}}class Lt extends Ot{constructor(t,s,i,h,e){super(t,s,"circle",i,h),rt(this,"radius"),this.radius=e}}class Pt extends Ot{constructor(t,s,i,h){super(t,s,"point",i,h)}}class jt{constructor(){rt(this,"objectTable",{}),rt(this,"objectList",[]),rt(this,"sortedXCoordinates",[]),this.sortedXCoordinates=[]}addObject(t){this.objectTable[t.uuid]=t,this.objectList.push(t),this.sortedXCoordinates.push({collider:t,x:t.worldPosition[0],left:!0}),this.sortedXCoordinates.push({collider:t,x:t.worldPosition[0]+(t.transform.width??0),left:!1})}removeObject(t){delete this.objectTable[t],this.objectList=this.objectList.filter((s=>s.uuid!==t))}updateXCoordinates(){for(const t of this.sortedXCoordinates)t.left?"circle"===t.collider.type?t.x=t.collider.worldPosition[0]-t.collider.radius:("rect"===t.collider.type||"point"===t.collider.type)&&(t.x=t.collider.worldPosition[0]):"circle"===t.collider.type?t.x=t.collider.worldPosition[0]+t.collider.radius:"rect"===t.collider.type?t.x=t.collider.worldPosition[0]+t.collider.transform.width:"point"===t.collider.type&&(t.x=t.collider.worldPosition[0])}sortXCoordinates(){this.sortedXCoordinates.sort(((t,s)=>t.x-s.x))}detectCollisions(){var t,s;this.updateXCoordinates(),this.sortXCoordinates();let i=new Set;for(const h of this.sortedXCoordinates)if(h.left){for(const t of i)this.isIntersecting(h.collider,t)&&(this.onColliderCollide(h.collider,t),this.onColliderCollide(t,h.collider));i.add(h.collider)}else i.delete(h.collider);for(const h of this.sortedXCoordinates)if(h.left){for(const i of h.collider.it)h.collider.st.has(i)||(null==(s=(t=h.collider.event.collider).onEndContact)||s.call(t,h.collider,i),h.collider.it.delete(i));h.collider.st.clear()}}isIntersecting(t,s){const i=t,h=s;return"rect"===i.type&&"rect"===h.type?this.isRectIntersecting(i,h):"circle"===i.type&&"circle"===h.type?this.isCircleIntersecting(i,h):"rect"===i.type&&"circle"===h.type?this.isRectCircleIntersecting(i,h):"circle"===i.type&&"rect"===h.type?this.isRectCircleIntersecting(h,i):"rect"===i.type&&"point"===h.type?this.isRectPointIntersecting(i,h):"point"===i.type&&"rect"===h.type?this.isRectPointIntersecting(h,i):"point"===i.type&&"circle"===h.type?this.isCirclePointIntersecting(h,i):"circle"===i.type&&"point"===h.type?this.isCirclePointIntersecting(i,h):"point"===i.type&&"point"===h.type&&this.isPointPointIntersecting(i,h)}onColliderCollide(t,s){var i,h;t.event.collider.onCollide&&t.event.collider.onCollide(t,s),t.it.has(s)||(null==(h=(i=t.event.collider).onBeginContact)||h.call(i,t,s),t.it.add(s)),t.st.add(s)}isRectIntersecting(t,s){return t.uuid!==s.uuid&&t.worldPosition[1]<s.worldPosition[1]+s.transform.height&&t.worldPosition[1]+t.transform.height>s.worldPosition[1]}isRectCircleIntersecting(t,s){let i=s.worldPosition[0],h=s.worldPosition[1];s.worldPosition[0]<t.worldPosition[0]?i=t.worldPosition[0]:s.worldPosition[0]>t.worldPosition[0]+t.transform.width&&(i=t.worldPosition[0]+t.transform.width),s.worldPosition[1]<t.worldPosition[1]?h=t.worldPosition[1]:s.worldPosition[1]>t.worldPosition[1]+t.transform.height&&(h=t.worldPosition[1]+t.transform.height);let e=s.worldPosition[0]-i,n=s.worldPosition[1]-h;return Math.sqrt(e*e+n*n)<=(s.radius??0)}isRectPointIntersecting(t,s){return s.worldPosition[0]>=t.worldPosition[0]&&s.worldPosition[0]<=t.worldPosition[0]+t.transform.width&&s.worldPosition[1]>=t.worldPosition[1]&&s.worldPosition[1]<=t.worldPosition[1]+t.transform.height}isCirclePointIntersecting(t,s){let i=t.worldPosition[0]-s.worldPosition[0],h=t.worldPosition[1]-s.worldPosition[1];return Math.sqrt(i*i+h*h)<=(t.radius??0)}isCircleIntersecting(t,s){if(t.uuid===s.uuid)return!1;let i=t.worldPosition[0]-s.worldPosition[0],h=t.worldPosition[1]-s.worldPosition[1];return Math.sqrt(i*i+h*h)<=(t.radius??0)+(s.radius??0)}isPointPointIntersecting(t,s){return t.uuid!==s.uuid&&(t.worldPosition[0]===s.worldPosition[0]&&t.worldPosition[1]===s.worldPosition[1])}}L=new WeakMap,P=new WeakMap,j=new WeakMap,S=new WeakSet,T=function(t,s){var i,h,e,n,r,l,o,a,u,c,d,f;let p=new Set;for(const g of s.values()){const s=g.values().next().value;if(s&&s.object.engine===this)for(const m of g.values())if(m.callback){for(const t of m.callback)t();p.has(m.object)||(p.add(m.object),m.object instanceof Mt&&("READ_1"==t?null==(h=(i=m.object.callback).afterRead1)||h.call(i):"READ_2"==t?null==(n=(e=m.object.callback).afterRead2)||n.call(e):"READ_3"==t?null==(l=(r=m.object.callback).afterRead3)||l.call(r):"WRITE_1"==t?null==(a=(o=m.object.callback).afterWrite1)||a.call(o):"WRITE_2"==t?null==(c=(u=m.object.callback).afterWrite2)||c.call(u):"WRITE_3"==t&&(null==(f=(d=m.object.callback).afterWrite3)||f.call(d))))}}};class St extends Mt{constructor(t,s){super(t,s),rt(this,"endWorldX"),rt(this,"endWorldY"),rt(this,"start"),rt(this,"target"),this.endWorldX=0,this.endWorldY=0,this.start=s,this.target=null,this.transformMode="direct"}setLineStartAtConnector(){const t=this.start.center;this.setLineStart(t.x,t.y)}setLineEndAtConnector(){if(this.target){const t=this.target.center;this.setLineEnd(t.x,t.y)}}setLineStart(t,s){this.worldPosition=[t,s]}setLineEnd(t,s){this.endWorldX=t,this.endWorldY=s}setLinePosition(t,s,i,h){this.setLineStart(t,s),this.setLineEnd(i,h)}moveLineToConnectorTransform(){this.setLineStartAtConnector(),this.target&&this.setLineEndAtConnector()}}X=new WeakMap,Y=new WeakMap,$=new WeakMap,F=new WeakMap,q=new WeakMap,G=new WeakMap,z=new WeakMap,U=new WeakMap,B=new WeakMap,N=new WeakMap;let Tt=class t extends Mt{constructor(t,s,i={}){super(t,s),at(this,X),at(this,Y),at(this,$),at(this,F),at(this,q),at(this,G,0),at(this,z),at(this,U),at(this,B,null),at(this,N,null),ut(this,$,{}),ut(this,F,[]),ut(this,q,[]),ut(this,X,i),ut(this,Y,i.name||this.gid||""),this.event.input.pointerDown=this.onCursorDown,ut(this,z,new Lt(t,this,0,0,i.colliderRadius??30)),this.addCollider(ot(this,z)),ut(this,U,new Pt(t,this,0,0)),this.addCollider(ot(this,U)),ut(this,B,null),this.transformMode="none",this.event.dom.onAssignDom=()=>{this.queueUpdate("READ_1",(()=>{this.readDom();const t=this.getDomProperty("READ_1"),s=t.width/2,i=t.height/2;ot(this,z).transform.x=s,ot(this,z).transform.y=i,ot(this,U).transform.x=s,ot(this,U).transform.y=i}))},ut(this,N,{onConnectOutgoing:null,onConnectIncoming:null,onDisconnectOutgoing:null,onDisconnectIncoming:null}),ut(this,N,mt(this,ot(this,N)))}get name(){return ot(this,Y)}get config(){return ot(this,X)}get prop(){return ot(this,$)}get outgoingLines(){return ot(this,F)}get incomingLines(){return ot(this,q)}get targetConnector(){return ot(this,B)}set targetConnector(t){ut(this,B,t)}get numIncomingLines(){return ot(this,q).length}get numOutgoingLines(){return ot(this,F).length}get center(){const t=this.getDomProperty("READ_1");return{x:this.transform.x+t.width/2,y:this.transform.y+t.height/2}}get connectorCallback(){return ot(this,N)}onCursorDown(t){const s=ot(this,q).filter((t=>!t._));0==t.event.button&&(this.inputEngine.resetDragMembers(),s.length>0?this.startPickUpLine(s[0],t):ot(this,X).allowDragOut&&this.startDragOutLine(t))}deleteLine(t){if(0==ot(this,F).length)return null;const s=ot(this,F)[t];return s.destroy(),ot(this,F).splice(t,1),s}deleteAllLines(){for(const t of ot(this,F))t.destroy()}updateAllLines(){var t;this.calculateTransformFromLocal();for(const s of[...ot(this,F),...ot(this,q)])null==(t=s.target)||t.calculateTransformFromLocal(),s.calculateLocalFromTransform(),s.moveLineToConnectorTransform(),s.requestTransform("WRITE_2")}assignToNode(t){this.parent=t,t.children.push(this);let s=this.parent;s.ht[ot(this,Y)]=null,ut(this,$,s.ht),s.et[ot(this,Y)]=this,ut(this,F,[]),ut(this,q,[]),s.global&&null==this.global&&(this.global=s.global)}createLine(){let t;return t=ot(this,X).lineClass?new(ot(this,X).lineClass)(this.engine,this):new St(this.engine,this),this.children.push(t),t}startDragOutLine(t){let s=this.createLine();s.setLineEnd(t.position.x,t.position.y),s.setLineStartAtConnector(),ot(this,F).unshift(s),this.parent.updateNodeLines(),this.parent.updateNodeLineList(),ut(this,G,1),ut(this,B,null),this.event.input.drag=this.runDragOutLine,this.event.input.dragEnd=this.endDragOutLine,ot(this,U).event.collider.onCollide=(t,s)=>{this.findClosestConnector()},ot(this,U).event.collider.onEndContact=(t,s)=>{var i;(null==(i=ot(this,B))?void 0:i.gid)==s.parent.gid&&ut(this,B,null)},this.runDragOutLine({position:t.position,start:{x:this.transform.x,y:this.transform.y},delta:{x:t.position.x-this.transform.x,y:t.position.y-this.transform.y}})}findClosestConnector(){let s=Array.from(ot(this,U).it).filter((s=>s.parent instanceof t)).map((t=>t.parent)).sort(((t,s)=>{const i=t.center,h=s.center;return Math.sqrt(Math.pow(i.x-ot(this,U).transform.x,2)+Math.pow(i.y-ot(this,U).transform.y,2))-Math.sqrt(Math.pow(h.x-ot(this,U).transform.x,2)+Math.pow(h.y-ot(this,U).transform.y,2))}));s.length>0?ut(this,B,s[0]):ut(this,B,null)}runDragOutLine(t){if(1!=ot(this,G))return;if(0==ot(this,F).length)return;ot(this,U).transform.x=t.position.x-this.transform.x,ot(this,U).transform.y=t.position.y-this.transform.y;let s=ot(this,F)[0];if(ot(this,B)){const t=this.hoverWhileDragging(ot(this,B));if(t)return s.setLineEnd(t[0],t[1]),s.setLineStartAtConnector(),void s.requestTransform("WRITE_2")}s.setLineEnd(t.position.x,t.position.y),s.setLineStartAtConnector(),this.parent.updateNodeLines()}hoverWhileDragging(s){if(!(s instanceof t))return;if(null==s)return;if(s.gid==this.gid)return;const i=s.center;return[i.x,i.y]}endDragOutLine(s){if(this.inputEngine.resetDragMembers(),ot(this,B)&&ot(this,B)instanceof t){const t=ot(this,B);if(null==t)return void this.nt();if(0==this.connectToConnector(t,ot(this,F)[0]))return this.nt(),void this.deleteLine(0);ot(t,$)[ot(t,Y)]=ot(this,$)[ot(this,Y)],ot(this,F)[0].setLineEnd(t.transform.x,t.transform.y)}else this.deleteLine(0);this.parent&&this.parent.updateNodeLines(),this.nt()}nt(){ut(this,G,0),this.event.global.pointerMove=null,this.event.global.pointerUp=null,this.parent.updateNodeLineList(),ut(this,B,null),ot(this,U).event.collider.onBeginContact=null,ot(this,U).event.collider.onEndContact=null,ot(this,U).transform.x=0,ot(this,U).transform.y=0}startPickUpLine(t,s){t.start.disconnectFromConnector(this),this.disconnectFromConnector(t.start),t.start.deleteLine(t.start.outgoingLines.indexOf(t)),this.inputEngine.resetDragMembers(),this.inputEngine.addDragMember(t.start.inputEngine),t.start.targetConnector=this,t.start.startDragOutLine(s),ut(this,G,1)}connectToConnector(t,s){var i,h,e,n;const r=t.incomingLines.filter((t=>!t._));return!r.some((t=>t.start==this))&&(t.config.maxConnectors!==r.length&&(null==s&&(s=this.createLine(),ot(this,F).unshift(s)),this.calculateLocalFromTransform(),s.target=t,t.incomingLines.push(s),this.parent.updateNodeLineList(),null==(h=null==(i=ot(this,N))?void 0:i.onConnectOutgoing)||h.call(i,t),null==(n=null==(e=ot(t,N))?void 0:e.onConnectIncoming)||n.call(e,this),this.parent.setProp(ot(this,Y),ot(this,$)[ot(this,Y)]),!0))}disconnectFromConnector(t){var s,i,h,e;for(const n of ot(this,F))if(n.target==t){n._=!0;break}null==(i=null==(s=ot(this,N))?void 0:s.onDisconnectOutgoing)||i.call(s,t),null==(e=null==(h=ot(t,N))?void 0:h.onDisconnectIncoming)||e.call(h,this)}};class Xt extends Mt{constructor(t,s,i={}){super(t,s),rt(this,"_config"),rt(this,"_connectors"),rt(this,"_components"),rt(this,"_nodeWidth",0),rt(this,"_nodeHeight",0),rt(this,"_dragStartX",0),rt(this,"_dragStartY",0),rt(this,"_prop"),rt(this,"_propSetCallback"),rt(this,"_nodeStyle"),rt(this,"_lineListCallback"),rt(this,"_hitBox"),rt(this,"_selected"),rt(this,"_mouseDownX"),rt(this,"_mouseDownY"),rt(this,"_hasMoved"),this.rt=i,this.et={},this.lt={},this.ot=this.transform.x,this.ut=this.transform.y,this.ct=0,this.dt=0,this.ht={},this.ft={},this.gt=null,this.transformMode="direct",this.event.input.pointerDown=this.onCursorDown,this.event.input.dragStart=this.onDragStart,this.event.input.drag=this.onDrag,this.event.input.dragEnd=this.onDragEnd,this.event.input.pointerUp=this.onUp,this.bt=new It(this.engine,this,0,0,0,0),this.addCollider(this.bt),this.wt=!1,this._t=!1,this.event.dom.onResize=()=>{this.queueUpdate("READ_1",(()=>{this.readDom(!1,"READ_1");for(const t of Object.values(this.et))t.readDom(!1,"READ_1"),t.calculateLocalFromDom("READ_1"),t.calculateTransformFromLocal()}));for(const t of[...this.getAllOutgoingLines(),...this.getAllIncomingLines()])t.queueUpdate("WRITE_1",(()=>{t.moveLineToConnectorTransform(),t.setLineEndAtConnector(),t.writeDom(),t.writeTransform()}))},this.style={willChange:"transform",position:"absolute",transformOrigin:"top left"},this.event.dom.onAssignDom=()=>{this.bt.element=this.element},this.global.data.select||(this.global.data.select=[])}setStartPositions(){this.ot=this.transform.x,this.ut=this.transform.y}setSelected(t){this.wt=t,this.dataAttribute={selected:t},t?this.global.data.select.push(this):(this.classList=this.classList.filter((t=>"selected"!==t)),this.global.data.select=this.global.data.select.filter((t=>t.gid!==this.gid))),this.requestWrite()}vt(t){for(let s=0;s<t.length;s++)t[s]._&&(t.splice(s,1),s--)}updateNodeLines(){for(const t of Object.values(this.et))t.updateAllLines()}updateNodeLineList(){this.gt&&this.gt(this.getAllOutgoingLines())}setLineListCallback(t){this.gt=t}onCursorDown(t){var s;if(0==t.event.button&&0==(null==(s=this.global.data.select)?void 0:s.includes(this))){for(const t of this.global.data.select)t.setSelected(!1);this.setSelected(!0)}}onDragStart(t){for(const s of this.global.data.select??[])s.setStartPositions(),s.ct=t.start.x,s.dt=t.start.y;this._t=!0}onDrag(t){if(null!=this.global&&!this.rt.lockPosition)for(const s of this.global.data.select??[])s.setDragPosition(t)}setDragPosition(t){const s=t.position.x-this.ct,i=t.position.y-this.dt;this.worldPosition=[this.ot+s,this.ut+i],this.updateNodeLines(),this.requestTransform("WRITE_2")}onDragEnd(t){for(const s of this.global.data.select??[])s.setUpPosition(t)}setUpPosition(t){const[s,i]=[t.end.x-this.ct,t.end.y-this.dt];this.worldPosition=[this.ot+s,this.ut+i],this.updateNodeLines()}onUp(t){if(0!=this._t);else{for(const t of this.global.data.select??[])t.setSelected(!1);this.setSelected(!0)}}getConnector(t){return t in this.et?this.et[t]:null}addConnectorObject(t){t.assignToNode(this)}addSetPropCallback(t,s){this.ft[s]=t}getAllOutgoingLines(){return Object.values(this.et).flatMap((t=>t.outgoingLines))}getAllIncomingLines(){return Object.values(this.et).flatMap((t=>t.incomingLines))}getProp(t){return this.ht[t]}setProp(t,s){if(t in this.ft&&this.ft[t](s),this.ht[t]=s,!(t in this.et))return;const i=this.et[t].outgoingLines.filter((t=>t.target&&!t._)).map((t=>t.target));if(i)for(const h of i){if(!h)continue;if(!h.parent)continue;h.parent.setProp(h.name,s)}}propagateProp(){for(const t of Object.values(this.et))this.setProp(t.name,this.getProp(t.name))}}class Yt extends Mt{constructor(t,s=!1,i=!1){super(t,null),rt(this,"_state","idle"),rt(this,"_mouseDownX"),rt(this,"_mouseDownY"),rt(this,"zoomLock"),rt(this,"panLock"),rt(this,"resizeObserver",null),at(this,Q,0),at(this,H,0),this.zoomLock=s,this.panLock=i,this.ct=0,this.dt=0,this.S="idle",this.event.global.pointerDown=this.onCursorDown,this.event.global.pointerMove=this.onCursorMove,this.event.global.pointerUp=this.onCursorUp,this.event.global.mouseWheel=this.onZoom,this.transformMode="direct",this.style={position:"absolute",left:"0px",top:"0px",width:"0px",height:"0px"},this.requestTransform("WRITE_2"),this.resizeObserver=null,ut(this,Q,0),ut(this,H,0),this.engine.event.containerElementAssigned=()=>{this.resizeObserver=new ResizeObserver((()=>{this.setCameraPosition(ot(this,Q),ot(this,H)),this.paintCamera()})),this.resizeObserver.observe(this.engine.containerElement),this.resizeObserver.observe(window.document.body)}}paintCamera(){var t,s,i;null==(t=this.engine.camera)||t.updateCameraProperty(),null==(s=this.engine.camera)||s.updateCamera(),this.style.transform=null==(i=this.engine.camera)?void 0:i.canvasStyle,this.requestTransform("WRITE_2")}updateCameraCenterPosition(t=0,s=0){var i,h,e;null==(i=this.engine.camera)||i.setCameraCenterPosition(t,s),ut(this,Q,(null==(h=this.engine.camera)?void 0:h.cameraPositionX)||0),ut(this,H,(null==(e=this.engine.camera)?void 0:e.cameraPositionY)||0),this.paintCamera()}setCameraPosition(t,s){var i;null==(i=this.engine.camera)||i.setCameraPosition(t,s),ut(this,Q,t),ut(this,H,s),this.paintCamera()}setCameraCenterPosition(t,s){var i,h,e;null==(i=this.engine.camera)||i.setCameraCenterPosition(t,s),ut(this,Q,(null==(h=this.engine.camera)?void 0:h.cameraPositionX)||0),ut(this,H,(null==(e=this.engine.camera)?void 0:e.cameraPositionY)||0),this.paintCamera()}getCameraCenterPosition(){var t;return(null==(t=this.engine.camera)?void 0:t.getCameraCenterPosition())||{x:0,y:0}}onCursorDown(t){var s;1==t.event.button&&(this.panLock||(this.S="panning",this.ct=t.position.screenX,this.dt=t.position.screenY,null==(s=this.engine.camera)||s.handlePanStart(),t.event.preventDefault()))}onCursorMove(t){var s,i;if("panning"!=this.S)return;const h=t.position.screenX-this.ct,e=t.position.screenY-this.dt;null==(s=this.engine.camera)||s.handlePanDrag(h,e),this.style.transform=null==(i=this.engine.camera)?void 0:i.canvasStyle,this.requestTransform("WRITE_2")}onCursorUp(t){var s,i,h,e;"panning"==this.S&&(this.S="idle",null==(s=this.engine.camera)||s.handlePanEnd(),this.style.transform=null==(i=this.engine.camera)?void 0:i.canvasStyle,ut(this,Q,(null==(h=this.engine.camera)?void 0:h.cameraPositionX)||0),ut(this,H,(null==(e=this.engine.camera)?void 0:e.cameraPositionY)||0),this.requestTransform("WRITE_2"))}onZoom(t){if(this.zoomLock)return;const s=this.engine.camera;t.position.screenX<s.containerOffsetX||t.position.screenX>s.containerOffsetX+s.cameraWidth||t.position.screenY<s.containerOffsetY||t.position.screenY>s.containerOffsetY+s.cameraHeight||(this.zoomBy(t.delta/2e3,t.position.cameraX,t.position.cameraY),t.event.preventDefault())}zoomBy(t,s,i){if(this.zoomLock)return;const h=this.engine.camera;if(!h)return;const e=s??h.cameraWidth/2,n=i??h.cameraHeight/2;h.handleScroll(t,e,n),this.style.transform=h.canvasStyle,ut(this,Q,h.cameraPositionX||0),ut(this,H,h.cameraPositionY||0),this.requestTransform("WRITE_2")}}Q=new WeakMap,H=new WeakMap;const $t=Object.freeze(Object.defineProperty({__proto__:null,CameraControl:Yt},Symbol.toStringTag,{value:"Module"}));let Ft=null;K=new WeakMap,Z=new WeakMap,J=new WeakMap,V=new WeakMap,tt=new WeakMap,st=new WeakMap,it=new WeakMap,ht=new WeakMap;const qt=Object.freeze(Object.defineProperty({__proto__:null,AnimationObject:class{constructor(t,s,i){rt(this,"target"),rt(this,"keyframe"),rt(this,"property"),at(this,K),at(this,Z),at(this,J),at(this,V),at(this,tt),at(this,st),at(this,it),at(this,ht),rt(this,"requestDelete"),this.target=t??(Ft||(Ft=document.createElement("div"),Ft.style.display="none",document.body.appendChild(Ft)),Ft),this.keyframe=s,this.property=i;const h=this.property.persist??!1;this.property.persist=h,ut(this,Z,null),this.property.duration||(this.property.duration=1e3),this.property.delay||(this.property.delay=0);let e=0;for(const[o,a]of Object.entries(this.keyframe)){const t=Array.isArray(a)?a.length:1;e=Math.max(e,t)}if(this.property.offset)ut(this,V,this.property.offset);else if(ut(this,V,[]),e<=1)ot(this,V).push(0);else for(let o=0;o<e;o++)ot(this,V).push(o/(e-1));this.property.easing?Array.isArray(this.property.easing)?ut(this,tt,this.property.easing):ut(this,tt,[this.property.easing]):ut(this,tt,["linear"]);const n=Math.max(1,ot(this,V).length-1);if(ot(this,tt).length<n){const t=ot(this,tt)[ot(this,tt).length-1]??"linear";for(;ot(this,tt).length<n;)ot(this,tt).push(t)}this.property.duration&&Array.isArray(this.property.duration)?ut(this,st,this.property.duration):ut(this,st,[this.property.duration]),this.property.delay?ut(this,it,this.property.delay):ut(this,it,0),ut(this,K,{}),ut(this,J,[]),ut(this,ht,Object.keys(this.keyframe).filter((t=>t.startsWith("$"))).length>0);let r={};for(const[o,a]of Object.entries(this.keyframe))o.startsWith("$")?ot(this,K)[o]=a:r[o]=a;ot(this,ht)&&0==Object.keys(r).length&&(r={}),this.property.offset&&(r.offset=this.property.offset);const l={delay:ot(this,it),fill:"both"};if(ot(this,st).length>1?r.duration=ot(this,st):l.duration=ot(this,st)[0],ot(this,tt).length>1?r.easing=ot(this,tt):l.easing=ot(this,tt)[0],ut(this,Z,new Animation(new KeyframeEffect(this.target,r,l))),this.requestDelete=!1,ot(this,Z).onfinish=()=>{var t,s,i,e;null==(s=(t=this.property).finish)||s.call(t),this.finish(),h?null==(i=ot(this,Z))||i.pause():(null==(e=ot(this,Z))||e.cancel(),this.requestDelete=!0)},ut(this,J,[]),ot(this,ht)&&ot(this,tt).length>1)for(let o=0;o<ot(this,V).length-1;o++){const t={};for(const[n,r]of Object.entries(ot(this,K)))t[n]=r.slice(o,o+1);const s=(ot(this,V)[o+1]-ot(this,V)[o])*this.property.duration,i=ot(this,V)[o]*this.property.duration+this.property.delay,h=ot(this,tt)[o],e=new Animation(new KeyframeEffect(this.target,t,{duration:s,delay:i,easing:h,fill:"both"}));e.onfinish=()=>{e.cancel()},e.persist(),ot(this,J).push(e)}}pause(){ot(this,Z).pause();for(let t=0;t<ot(this,J).length;t++)ot(this,J)[t].pause()}play(){ot(this,Z).play();for(let t=0;t<ot(this,J).length;t++)ot(this,J)[t].play()}cancel(){ot(this,Z).cancel();for(let t=0;t<ot(this,J).length;t++)ot(this,J)[t].cancel()}reverse(){ot(this,Z).reverse();for(let t=0;t<ot(this,J).length;t++)ot(this,J)[t].reverse()}calculateFrame(t){var s,i,h,e;const n=ot(this,Z).effect.getComputedTiming().progress;if(null==n)return!1;const r=this.property.duration*n+this.property.delay;if(ot(this,ht)){let t=0;for(let s=0;s<ot(this,V).length-1;s++)if(ot(this,V)[s]<=n&&n<ot(this,V)[s+1]){t=s;break}n>=1&&(t=ot(this,V).length-2);let h=n;if(ot(this,tt).length>1){const s=ot(this,J)[t];s.currentTime=r,h=s.effect.getComputedTiming().progress??0}const e={};for(const[s,i]of Object.entries(ot(this,K))){const n=i[t],r=n+(i[t+1]-n)*h;e[s]=r}null==(i=(s=this.property).tick)||i.call(s,e)}else null==(e=(h=this.property).tick)||e.call(h,{});return!1}finish(){var t;try{null==(t=ot(this,Z))||t.commitStyles()}catch(s){}}set currentTime(t){ot(this,Z).currentTime=t;for(let s=0;s<ot(this,J).length;s++)ot(this,J)[s].currentTime=t}set progress(t){this.currentTime=(this.property.duration+this.property.delay)*t}},SequenceObject:class{constructor(){rt(this,"animations"),rt(this,"startTime"),rt(this,"endTime"),rt(this,"expired"),rt(this,"requestDelete"),this.animations=[],this.startTime=-1,this.endTime=-1,this.expired=!1,this.requestDelete=!1}add(t){this.animations.push(t)}play(){for(let t=0;t<this.animations.length;t++)this.animations[t].play()}pause(){for(let t=0;t<this.animations.length;t++)this.animations[t].pause()}cancel(){for(let t=0;t<this.animations.length;t++)this.animations[t].cancel()}reverse(){for(let t=0;t<this.animations.length;t++)this.animations[t].reverse()}calculateFrame(t){let s=!1;for(let i=0;i<this.animations.length;i++)s=this.animations[i].calculateFrame(t)||s;return s}set currentTime(t){for(let s=0;s<this.animations.length;s++)this.animations[s].currentTime=t}set progress(t){for(let s=0;s<this.animations.length;s++)this.animations[s].progress=t}}},Symbol.toStringTag,{value:"Module"}));const Gt=Object.freeze(Object.defineProperty({__proto__:null,DebugRendererImpl:class{constructor(){rt(this,"debugWindow",null),rt(this,"debugCtx",null)}enable(t){if(this.debugWindow)return;this.debugWindow=document.createElement("canvas"),this.debugWindow.style.position="absolute",this.debugWindow.style.top="0",this.debugWindow.style.left="0";const s=t.getBoundingClientRect();this.debugWindow.width=s.width,this.debugWindow.height=s.height,this.debugWindow.style.zIndex="1000",this.debugWindow.style.pointerEvents="none",t.appendChild(this.debugWindow),this.debugCtx=this.debugWindow.getContext("2d")}disable(){this.debugWindow&&(this.debugWindow.remove(),this.debugWindow=null,this.debugCtx=null)}updateSize(t,s){this.debugWindow&&(this.debugWindow.width=t,this.debugWindow.height=s)}renderFrame(t,s,i){var h,e,n;if(null!=this.debugWindow){null==(h=this.debugCtx)||h.clearRect(0,0,this.debugWindow.width,this.debugWindow.height),this.renderDebugGrid(s);for(const t of Object.values(i))this.debugObjectBoundingBox(t,s);if(null!=this.debugCtx){for(const t of Object.values(s.debugMarkerList)){const[i,h]=(null==(e=s.camera)?void 0:e.getCameraFromWorld(t.x,t.y))??[0,0];if("point"==t.type)this.debugCtx.beginPath(),this.debugCtx.fillStyle=t.color,this.debugCtx.arc(i,h,5,0,2*Math.PI),this.debugCtx.fill();else if("rect"==t.type)this.debugCtx.beginPath(),!1!==t.filled?(this.debugCtx.fillStyle=t.color,this.debugCtx.rect(i,h,t.width,t.height),this.debugCtx.fill()):(this.debugCtx.strokeStyle=t.color,this.debugCtx.lineWidth=t.lineWidth??1,this.debugCtx.strokeRect(i,h,t.width,t.height));else if("circle"==t.type)this.debugCtx.beginPath(),this.debugCtx.fillStyle=t.color,this.debugCtx.arc(i,h,t.radius,0,2*Math.PI),this.debugCtx.fill();else if("text"==t.type)this.debugCtx.fillStyle=t.color,this.debugCtx.fillText(t.text,i,h);else if("line"==t.type){const[e,r]=(null==(n=s.camera)?void 0:n.getCameraFromWorld(t.x2,t.y2))??[0,0];this.debugCtx.beginPath(),this.debugCtx.strokeStyle=t.color,this.debugCtx.lineWidth=t.lineWidth??2,this.debugCtx.moveTo(i,h),this.debugCtx.lineTo(e,r),this.debugCtx.stroke()}}for(const t in s.debugMarkerList)s.debugMarkerList[t].persistent||delete s.debugMarkerList[t]}}}debugObjectBoundingBox(t,s){var i,h,e;if(null==this.debugCtx)return;const[n,r]=(null==(i=s.camera)?void 0:i.getCameraFromWorld(...t.worldPosition))??[0,0];if(t.hasOwnProperty("_dom")){let i=t;const e=["#FF0000A0","#00FF00A0","#0000FFA0"],l=["READ_1","READ_2","READ_3"];for(let t=0;t<3;t++){const n=i.getDomProperty(l[t]);this.debugCtx.stroke(),this.debugCtx.beginPath(),this.debugCtx.strokeStyle=e[t],this.debugCtx.lineWidth=1;const[r,o]=(null==(h=s.camera)?void 0:h.getCameraFromWorld(n.x,n.y))??[0,0];this.debugCtx.rect(r,o,n.width,n.height),this.debugCtx.stroke()}this.debugCtx.beginPath(),this.debugCtx.strokeStyle="black",this.debugCtx.lineWidth=1,this.debugCtx.rect(n,r,i.l.property.width,i.l.property.height)}const l="rgba(0, 247, 255, 0.5)";for(let o of t.o){this.debugCtx.beginPath(),this.debugCtx.strokeStyle=l,this.debugCtx.lineWidth=1;const[i,h]=(null==(e=s.camera)?void 0:e.getCameraFromWorld(t.transform.x+o.transform.x,t.transform.y+o.transform.y))??[0,0];"circle"==o.type?(this.debugCtx.arc(i,h,o.radius,0,2*Math.PI),this.debugCtx.stroke()):"rect"==o.type?(this.debugCtx.rect(i,h,o.transform.width,o.transform.height),this.debugCtx.stroke()):"point"==o.type&&(this.debugCtx.arc(i,h,2,0,2*Math.PI),this.debugCtx.fillStyle=l,this.debugCtx.fill())}}renderDebugGrid(t){if(null==this.debugCtx)return;const s=100,i=t.camera;if(!i)return;const[h,e]=i.getWorldFromCamera(0,0),[n,r]=i.getWorldFromCamera(this.debugWindow.width,this.debugWindow.height),l=Math.floor(h/s)*s,o=Math.ceil(n/s)*s,a=Math.floor(e/s)*s,u=Math.ceil(r/s)*s;this.debugCtx.beginPath(),this.debugCtx.strokeStyle="rgba(200, 200, 200, 0.3)",this.debugCtx.lineWidth=1;for(let p=l;p<=o;p+=s){const[t,s]=i.getCameraFromWorld(p,e),[h,n]=i.getCameraFromWorld(p,r);this.debugCtx.moveTo(t,s),this.debugCtx.lineTo(h,n)}for(let p=a;p<=u;p+=s){const[t,s]=i.getCameraFromWorld(h,p),[e,r]=i.getCameraFromWorld(n,p);this.debugCtx.moveTo(t,s),this.debugCtx.lineTo(e,r)}this.debugCtx.stroke(),this.debugCtx.beginPath(),this.debugCtx.strokeStyle="rgba(0, 0, 0, 0.8)",this.debugCtx.lineWidth=2;const c=l<=0&&o>=0;if(a<=0&&u>=0){const[t,s]=i.getCameraFromWorld(l,0),[h,e]=i.getCameraFromWorld(o,0);this.debugCtx.moveTo(t,s),this.debugCtx.lineTo(h,e)}if(c){const[t,s]=i.getCameraFromWorld(0,a),[h,e]=i.getCameraFromWorld(0,u);this.debugCtx.moveTo(t,s),this.debugCtx.lineTo(h,e)}this.debugCtx.stroke(),this.debugCtx.fillStyle="rgba(0, 0, 0, 0.8)",this.debugCtx.font="12px Arial",this.debugCtx.textAlign="center";for(let p=l;p<=o;p+=s){if(0===p)continue;const[t,s]=i.getCameraFromWorld(p,0);s>=0&&s<=this.debugWindow.height&&this.debugCtx.fillText(p.toString(),t,s+20)}for(let p=a;p<=u;p+=s){if(0===p)continue;const[t,s]=i.getCameraFromWorld(0,p);t>=0&&t<=this.debugWindow.width&&this.debugCtx.fillText(p.toString(),t-20,s+4)}const[d,f]=[0,0];d>=0&&d<=this.debugWindow.width&&f>=0&&f<=this.debugWindow.height&&this.debugCtx.fillText("(0,0)",d+20,f-10)}}},Symbol.toStringTag,{value:"Module"}));t.Background=class extends Mt{constructor(t,s){super(t,s),rt(this,"_tileSize",40),this.event.global.pointerMove=this.moveBackground,this.l.style={position:"absolute",top:"0",left:"0",backgroundSize:`${this.Dt}px ${this.Dt}px`},this.moveBackground()}moveBackground(t){var s,i,h,e;let n=null==(s=this.engine.camera)?void 0:s.cameraPositionX,r=null==(i=this.engine.camera)?void 0:i.cameraPositionY,l=5*(null==(h=this.engine.camera)?void 0:h.cameraWidth),o=5*(null==(e=this.engine.camera)?void 0:e.cameraHeight);this.worldPosition=[Math.floor(n/this.Dt)*this.Dt-l/2,Math.floor(r/this.Dt)*this.Dt-o/2],this.l.style={width:`${l}px`,height:`${o}px`},this.requestWrite()}},t.BaseObject=vt,t.CameraControl=Yt,t.ConnectorComponent=Tt,t.ElementObject=Mt,t.Engine=class{constructor(t={},s=!0){at(this,S),rt(this,"engineConfig"),rt(this,"global",null),rt(this,"containerElement",null),rt(this,"cursor"),rt(this,"camera",null),rt(this,"collisionEngine",null),rt(this,"animationList",[]),rt(this,"debugMarkerList",{}),rt(this,"_event"),rt(this,"event"),at(this,L,null),at(this,P,null),at(this,j,null),s&&(this.global=kt.getInstance(),this.global.registerEngine(this)),this.cursor={worldX:0,worldY:0,cameraX:0,cameraY:0,screenX:0,screenY:0};this.engineConfig={cameraConfig:{enableZoom:!0,enablePan:!0,panBounds:{top:null,left:null,right:null,bottom:null}},...t},this.G={containerElementAssigned:null},this.event=mt(this,this.G),ut(this,L,new ResizeObserver((()=>{if(ot(this,j)){let t=this.containerElement.getBoundingClientRect();ot(this,j).updateSize(t.width,t.height)}})))}async enableDebug(){if(null==this.containerElement)return;if(ot(this,j))return;const{DebugRendererImpl:t}=await Promise.resolve().then((()=>Gt));ut(this,j,new t),ot(this,j).enable(this.containerElement)}async enableCameraControl(t=!0,s=!0){const{CameraControl:i}=await Promise.resolve().then((()=>$t)),h=new i(this,t,s);return this.containerElement&&(h.element=this.containerElement),h}disableDebug(){ot(this,j)&&(ot(this,j).disable(),ut(this,j,null))}assignDom(t){var s,i,h;this.containerElement=t,this.camera=new dt(t),null==(i=(s=this.event).containerElementAssigned)||i.call(s,t),null==(h=ot(this,L))||h.observe(t)}K(t,s,i){ct(this,S,T).call(this,t,s)}Z(t){var s;null==(s=ot(this,P))||s.call(this,t)}J(t){var s,i;null==(s=this.collisionEngine)||s.detectCollisions();const h={timestamp:t},e=this.global.getEngineObjectTable(this,!1)??{};null==(i=ot(this,j))||i.renderFrame(h,this,e)}enableCollisionEngine(){this.collisionEngine||(this.collisionEngine=new jt)}enableAnimationEngine(){ot(this,P)||ut(this,P,(t=>{const s=[];for(const i of this.animationList){!1===i.calculateFrame(t)&&!1===i.requestDelete?s.push(i):Dt(i)}this.animationList=s}))}destroy(){this.global.unregisterEngine(this),ot(this,L)&&this.containerElement&&(ot(this,L).unobserve(this.containerElement),ut(this,L,null)),ot(this,j)&&this.disableDebug(),this.containerElement=null,this.camera=null,this.collisionEngine=null,this.animationList=[],this.debugMarkerList={},ut(this,P,null)}},t.GlobalManager=kt,t.LineComponent=St,t.NodeComponent=Xt,t.RectSelectComponent=class extends Mt{constructor(t,s){super(t,s),rt(this,"_state"),rt(this,"_mouseDownX"),rt(this,"_mouseDownY"),rt(this,"_selectHitBox"),this.S="none",this.ct=0,this.dt=0,this.event.global.pointerDown=this.onGlobalCursorDown,this.event.global.pointerMove=this.onGlobalCursorMove,this.event.global.pointerUp=this.onGlobalCursorUp,this.Et=new It(t,this,0,0,0,0),this.Et.transform.x=0,this.Et.transform.y=0,this.Et.event.collider.onCollide=this.onCollideNode,this.addCollider(this.Et),this.global.data.select=[],this.style={width:"0px",height:"0px",transformOrigin:"top left",position:"absolute",left:"0px",top:"0px",pointerEvents:"none"},this.requestWrite()}onGlobalCursorDown(t){if(!(0!==t.event.button||t.event.target&&"sl-background"!==t.event.target.id)){for(let t of this.global.data.select)t.setSelected(!1);this.global.data.select=[],this.worldPosition=[t.position.x,t.position.y],this.Et.recalculate(),this.S="dragging",this.style={display:"block",width:"0px",height:"0px"},this.ct=t.position.x,this.dt=t.position.y,this.Et.event.collider.onBeginContact=(t,s)=>{if(s.parent instanceof Xt){s.parent.setSelected(!0)}},this.Et.event.collider.onEndContact=(t,s)=>{if(s.parent instanceof Xt){s.parent.setSelected(!1)}}}}onGlobalCursorMove(t){if("dragging"===this.S){let[s,i]=[Math.min(this.ct,t.position.x),Math.min(this.dt,t.position.y)],[h,e]=[Math.abs(t.position.x-this.ct),Math.abs(t.position.y-this.dt)];this.style={width:`${h}px`,height:`${e}px`},this.worldPosition=[s,i],this.Et.transform.x=this.transform.x-s,this.Et.transform.y=this.transform.y-i,this.Et.transform.width=h,this.Et.transform.height=e,this.requestTransform()}}onGlobalCursorUp(t){this.style={display:"none"},this.S="none",this.Et.event.collider.onBeginContact=null,this.Et.event.collider.onEndContact=null,this.requestTransform()}onCollideNode(t,s){}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
